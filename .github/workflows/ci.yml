name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-test:
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-13, clang-21]
        features: [OFF, ON]
        build: [Debug, Release]
    runs-on: ubuntu-latest

    env:
      CMAKE_BUILD_TYPE: ${{ matrix.build }}
      WITH_BENCHMARKS: ${{ matrix.build == 'Release' && 'ON' || 'OFF' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Release dependencies
        if: ${{ matrix.build == 'Release' }}
        run: | 
          sudo apt-get install -y libjsoncpp-dev uuid-dev

      - name: Install all dependencies with features
        if: ${{ matrix.features == 'ON' }}
        run: |
          sudo apt-get install -y libssl-dev libcurl4-openssl-dev libprotobuf-dev protobuf-compiler

      - name: Install GCC toolchain
        if: ${{ startsWith(matrix.compiler, 'gcc') }}
        run: sudo apt-get install -y ${{ matrix.compiler }}

      - name: Install Clang/LLVM toolchain
        if: ${{ startsWith(matrix.compiler, 'clang') }}
        run: |
            wget --retry-connrefused --waitretry=5 --tries=5 https://apt.llvm.org/llvm.sh
            chmod +x llvm.sh
            compiler="${{ matrix.compiler }}"
            version="${compiler##*-}"
            echo "Detected clang version: $version"
            sudo ./llvm.sh "$version"
            sudo apt-get install -y "clang-tidy-$version" "lld-$version"

      - name: Derive CC/CXX environment
        run: |
          compiler="${{ matrix.compiler }}"
          echo "CC=$compiler" >> $GITHUB_ENV
          ver="${compiler##*-}"
          if [[ "$compiler" == gcc-* ]]; then
            echo "CXX=g++-$ver" >> $GITHUB_ENV
          else
            echo "CXX=clang++-$ver" >> $GITHUB_ENV
          fi
          echo "Derived compilers: CC=$compiler CXX set for version $ver"

      - name: Show compiler version
        run: |
          $CXX --version

      - name: Configure (CMake)
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DAERONET_BUILD_TESTS=ON \
            -DAERONET_BUILD_EXAMPLES=ON \
            -DAERONET_BUILD_BENCHMARKS=${WITH_BENCHMARKS} \
            -DAERONET_ENABLE_ASAN=ON \
            ${{ startsWith(matrix.compiler, 'clang') && '-DAERONET_ENABLE_CLANG_TIDY=OFF' || '' }} \
            -DAERONET_ENABLE_SPDLOG=${{ matrix.features }} \
            -DAERONET_ENABLE_OPENSSL=${{ matrix.features }} \
            -DAERONET_ENABLE_KTLS=${{ matrix.features }} \
            -DAERONET_ENABLE_BROTLI=${{ matrix.features }} \
            -DAERONET_ENABLE_ZLIB=${{ matrix.features }} \
            -DAERONET_ENABLE_ZSTD=${{ matrix.features }} \
            -DAERONET_ENABLE_OPENTELEMETRY=${{ matrix.features }}

      - name: Build
        run: |
          cmake --build build --parallel

      - name: Run unit tests
        run: |
          NUM_PROC=$(nproc)
          # Use half the CPUs for parallelism, but at least 1
          JOBS=$(( (NUM_PROC / 2) > 0 ? (NUM_PROC / 2) : 1 ))
          echo "Running ctest with -j=${JOBS} (NUM_PROC=${NUM_PROC})"
          ctest --test-dir build --repeat until-fail:3 --output-on-failure --timeout 100 -j ${JOBS}

      - name: Summary
        if: always()
        run: |
          echo "Compiler: $CXX" >> $GITHUB_STEP_SUMMARY
          echo "features: ${{ matrix.features }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "Tests executed:" >> $GITHUB_STEP_SUMMARY
          ctest --test-dir build -N | sed 's/^/  /' >> $GITHUB_STEP_SUMMARY

      - name: Install artifact (optional)
        if: always()
        run: |
          cmake --install build --prefix install || true

      - name: Upload install dir artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          # NOTE: Artifact names must be globally unique within a single workflow run.
          # The previous name omitted the build type, so Debug and Release matrix legs
          # attempted to create the same artifact name, yielding HTTP 409 Conflict.
          # Adding the build axis (and keeping compiler + features toggle) makes each
          # matrix combination distinct. If you ever re-run a failed job (run_attempt > 1)
          # and want full uniqueness across attempts, you could append `-ra${{ github.run_attempt }}`.
          name: aeronet-${{ matrix.compiler }}-features-${{ matrix.features }}-build-${{ matrix.build }}
          path: install
          if-no-files-found: ignore
          retention-days: 7

  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      BUILD_DIR: build-coverage
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install coverage toolchain and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential \
            libjsoncpp-dev uuid-dev libssl-dev libcurl4-openssl-dev \
            libprotobuf-dev protobuf-compiler python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install gcovr

      - name: Configure with coverage flags
        run: |
          cmake -S . -B ${BUILD_DIR} -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DAERONET_BUILD_TESTS=ON \
            -DAERONET_BUILD_EXAMPLES=OFF \
            -DAERONET_BUILD_BENCHMARKS=OFF \
            -DAERONET_ENABLE_ASAN=OFF \
            -DAERONET_ENABLE_CLANG_TIDY=OFF \
            -DAERONET_ENABLE_SPDLOG=ON \
            -DAERONET_ENABLE_OPENSSL=ON \
            -DAERONET_ENABLE_KTLS=ON \
            -DAERONET_ENABLE_BROTLI=ON \
            -DAERONET_ENABLE_ZLIB=ON \
            -DAERONET_ENABLE_ZSTD=ON \
            -DAERONET_ENABLE_OPENTELEMETRY=ON \
            -DCMAKE_C_FLAGS="--coverage -fno-inline -fno-inline-functions" \
            -DCMAKE_CXX_FLAGS="--coverage -fno-inline -fno-inline-functions" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build (coverage)
        run: cmake --build ${BUILD_DIR} --parallel

      - name: Run unit tests (coverage)
        run: |
          NUM_PROC=$(nproc)
          # Use half the CPUs for parallelism, but at least 1
          JOBS=$(( (NUM_PROC / 2) > 0 ? (NUM_PROC / 2) : 1 ))
          echo "Running ctest with -j=${JOBS} (NUM_PROC=${NUM_PROC})"
          ctest --test-dir ${BUILD_DIR} --repeat until-fail:3 --output-on-failure --timeout 100 -j ${JOBS}

      - name: Generate coverage reports
        run: |
          # Generate XML (Cobertura) report
          gcovr --root . --object-directory build-coverage \
            --filter 'aeronet/' \
            --exclude 'aeronet/test_support' \
            --exclude '.*CompilerId.*' \
            --exclude '.*_test\.cpp$' \
            --exclude 'build-coverage/_deps' \
            --gcov-ignore-errors=no_working_dir_found \
            --gcov-ignore-errors=source_not_found \
            --gcov-ignore-parse-errors=negative_hits.warn_once_per_file \
            --txt-metric branch \
            --xml --xml-pretty \
            --output build-coverage/coverage.xml \
            --print-summary

          # Generate HTML detailed report
          gcovr --root . --object-directory build-coverage \
            --filter 'aeronet/' \
            --exclude 'aeronet/test_support' \
            --exclude '.*CompilerId.*' \
            --exclude '.*_test\.cpp$' \
            --exclude 'build-coverage/_deps' \
            --gcov-ignore-errors=no_working_dir_found \
            --gcov-ignore-errors=source_not_found \
            --gcov-ignore-parse-errors=negative_hits.warn_once_per_file \
            --txt-metric branch \
            --html-details \
            --output build-coverage/coverage.html

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: build-coverage/coverage.xml
          flags: unittests
          name: aeronet-unit-tests
          fail_ci_if_error: true
          disable_search: true
          verbose: true
          
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: |
            build-coverage/coverage.xml
            build-coverage/coverage.html

  examples-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      BUILD_DIR: build-examples
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install example dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libjsoncpp-dev uuid-dev \
            libssl-dev libcurl4-openssl-dev libprotobuf-dev protobuf-compiler

      - name: Configure examples build
        run: |
          cmake -S . -B ${BUILD_DIR} -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DAERONET_BUILD_EXAMPLES=ON \
            -DAERONET_BUILD_TESTS=OFF \
            -DAERONET_BUILD_BENCHMARKS=OFF \
            -DAERONET_ENABLE_ASAN=OFF \
            -DAERONET_ENABLE_SPDLOG=ON \
            -DAERONET_ENABLE_OPENSSL=ON \
            -DAERONET_ENABLE_KTLS=ON \
            -DAERONET_ENABLE_BROTLI=ON \
            -DAERONET_ENABLE_ZLIB=ON \
            -DAERONET_ENABLE_ZSTD=ON \
            -DAERONET_ENABLE_OPENTELEMETRY=ON

      - name: Build examples
        run: |
          cmake --build ${BUILD_DIR} --parallel --target \
          aeronet \
          aeronet-async-handle \
          aeronet-async-handlers \
          aeronet-minimal \
          aeronet-multi \
          aeronet-sendfile \
          aeronet-static-example \
          aeronet-tls-ktls \
          aeronet-tls-session-tickets \
          aeronet-websocket-echo

      - name: Generate TLS certificate for ktls example
        run: |
          mkdir -p ${BUILD_DIR}/certs
          openssl req -x509 -nodes -newkey rsa:2048 \
            -keyout ${BUILD_DIR}/certs/server.key \
            -out ${BUILD_DIR}/certs/server.crt \
            -days 1 -subj "/CN=localhost"

      - name: Smoke test examples
        env:
          EXAMPLE_DIR: ${{ env.BUILD_DIR }}/examples
        run: |
          set -euo pipefail

          run_server_and_curl() {
            local label="$1"; shift
            local url="$1"; shift
            local curl_opts=()
            while [[ $# -gt 0 ]]; do
              if [[ "$1" == "--" ]]; then
                shift
                break
              fi
              curl_opts+=("$1")
              shift
            done
            local logfile="${BUILD_DIR}/${label}.log"
            local cmd=("$@")
            echo "::group::example-${label}"
            "${cmd[@]}" >"$logfile" 2>&1 &
            local pid=$!
            local success=0
            for attempt in {1..30}; do
              if curl -fsS "${curl_opts[@]}" "$url" >/tmp/aeronet-${label}.out; then
                cat /tmp/aeronet-${label}.out
                success=1
                break
              fi
              if ! kill -0 "$pid" 2>/dev/null; then
                echo "${label} exited before responding" >&2
                break
              fi
              sleep 0.5
            done
            kill -INT "$pid" 2>/dev/null || true
            wait "$pid" || true
            if [[ $success -ne 1 ]]; then
              echo "--- ${label} logs ---" >&2
              cat "$logfile" >&2 || true
              exit 1
            fi
            echo "Logs stored in $logfile"
            echo "::endgroup::"
          }

          run_server_and_curl async-handle "http://127.0.0.1:18080/hello" -- \
            "${EXAMPLE_DIR}/aeronet-async-handle" 18080

          run_server_and_curl async-handlers "http://127.0.0.1:18081/async" -- \
            "${EXAMPLE_DIR}/aeronet-async-handlers" 18081

          run_server_and_curl minimal "http://127.0.0.1:18082/hello" -- \
            "${EXAMPLE_DIR}/aeronet-minimal" 18082

          run_server_and_curl multi "http://127.0.0.1:18083/test" -- \
            "${EXAMPLE_DIR}/aeronet-multi" 18083 2

          tmp_file="${BUILD_DIR}/sendfile.txt"
          echo "Hello sendfile example" >"${tmp_file}"
          run_server_and_curl sendfile "http://127.0.0.1:18084/static" -- \
            "${EXAMPLE_DIR}/aeronet-sendfile" 18084 "${tmp_file}"

          run_server_and_curl static "http://127.0.0.1:18085/" -- \
            "${EXAMPLE_DIR}/aeronet-static-example" 18085 .
            
          run_server_and_curl tls "https://127.0.0.1:18443/" -k -- \
            "${EXAMPLE_DIR}/aeronet-tls-ktls" ${BUILD_DIR}/certs/server.crt ${BUILD_DIR}/certs/server.key 18443

          run_server_and_curl tls-session-tickets "https://127.0.0.1:18444/" -k -- \
            "${EXAMPLE_DIR}/aeronet-tls-session-tickets" ${BUILD_DIR}/certs/server.crt ${BUILD_DIR}/certs/server.key 18444

          run_server_and_curl websocket-echo "http://127.0.0.1:18086/" -- \
            "${EXAMPLE_DIR}/aeronet-websocket-echo" 18086

      - name: Verify markdown C/C++ examples (compile & link)
        run: |
          set -euo pipefail
          echo "Running markdown examples verifier against README.md and FEATURES.md"
          NUM_PROC=$(nproc)
          # Use half the CPUs for parallelism, but at least 1
          JOBS=$(( ((NUM_PROC + 1) / 2) ))
          scripts/verify-md-code.py -j ${JOBS} --link --build-dir ${BUILD_DIR} README.md docs/FEATURES.md

  alpine-musl-debug:
    name: Alpine (musl) Debug build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup latest Alpine Linux
        uses: jirutka/setup-alpine@v1

      - name: Run script inside Alpine chroot as root
        run: |
          set -euo pipefail
          
          cat /etc/alpine-release
          
          apk update
          apk add --no-cache build-base cmake ninja git bash python3 linux-headers \
            openssl-dev zlib-dev zstd-dev brotli-dev curl-dev protobuf-dev musl-dev
        shell: alpine.sh --root {0}

      - name: Run script inside Alpine chroot as the default user (unprivileged)
        run: |
          cmake -S . -B build-alpine -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DAERONET_BUILD_TESTS=ON \
            -DAERONET_BUILD_EXAMPLES=ON \
            -DAERONET_BUILD_BENCHMARKS=OFF \
            -DAERONET_ENABLE_ASAN=OFF \
            -DAERONET_ENABLE_SPDLOG=ON \
            -DAERONET_ENABLE_OPENSSL=ON \
            -DAERONET_ENABLE_KTLS=ON \
            -DAERONET_ENABLE_BROTLI=ON \
            -DAERONET_ENABLE_ZLIB=ON \
            -DAERONET_ENABLE_ZSTD=ON \
            -DAERONET_ENABLE_OPENTELEMETRY=ON

          cmake --build build-alpine --parallel

          ctest --test-dir build-alpine --output-on-failure --repeat until-fail:3 --timeout 100
        shell: alpine.sh {0}