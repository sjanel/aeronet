name: Benchmarks and GitHub pages Sync

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Weekly scheduled run on main to produce more stable benchmark results
  schedule:
    - cron: '0 3 * * 0'  # every Sunday at 03:00 UTC
  # Allow manual runs via the Actions UI with an optional duration override
  workflow_dispatch:
    inputs:
      bench_duration:
        description: 'Benchmark duration (e.g. 90s)'
        required: false
        default: '90s'

permissions:
  contents: write

jobs:
  sync:
    name: Benchmarks and Pages Sync
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-13, clang-21]
    steps:
      - name: Checkout current main
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install all dependencies with features
        run: |
          sudo apt install -y wrk libjsoncpp-dev uuid-dev libssl-dev libcurl4-openssl-dev
          pip install uvicorn starlette

      - name: Install GCC toolchain
        if: ${{ startsWith(matrix.compiler, 'gcc') }}
        run: sudo apt-get install -y ${{ matrix.compiler }}

      - name: Install Clang/LLVM toolchain
        if: ${{ startsWith(matrix.compiler, 'clang') }}
        run: |
            wget --retry-connrefused --waitretry=5 --tries=5 https://apt.llvm.org/llvm.sh
            chmod +x llvm.sh
            compiler="${{ matrix.compiler }}"
            version="${compiler##*-}"
            echo "Detected clang version: $version"
            sudo ./llvm.sh "$version"
            sudo apt-get install -y "lld-$version"

      - name: Derive CC/CXX environment
        run: |
          compiler="${{ matrix.compiler }}"
          echo "CC=$compiler" >> $GITHUB_ENV
          ver="${compiler##*-}"
          if [[ "$compiler" == gcc-* ]]; then
            echo "CXX=g++-$ver" >> $GITHUB_ENV
          else
            echo "CXX=clang++-$ver" >> $GITHUB_ENV
          fi
          echo "Derived compilers: CC=$compiler CXX set for version $ver"

      - name: Show compiler version
        run: |
          $CXX --version
          
      - name: Configure git identity for runner
        run: |
          # Ensure commits performed by this workflow have an author identity
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Assemble site content from main
        run: |
          rm -rf /tmp/site
          mkdir -p /tmp/site
          rsync -a docs/ /tmp/site/docs/
          rsync -a resources/ /tmp/site/resources/
          cp README.md /tmp/site/index.md

      - name: Configure benchmark build
        run: |
          cmake -S . -B build-pages -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DAERONET_BUILD_TESTS=OFF \
            -DAERONET_BUILD_EXAMPLES=OFF \
            -DAERONET_BUILD_BENCHMARKS=ON \
            -DAERONET_ENABLE_ASAN=OFF \
            -DAERONET_ENABLE_CLANG_TIDY=OFF \
            -DAERONET_ENABLE_SPDLOG=ON \
            -DAERONET_ENABLE_OPENSSL=ON \
            -DAERONET_ENABLE_KTLS=ON \
            -DAERONET_ENABLE_BROTLI=ON \
            -DAERONET_ENABLE_ZLIB=ON \
            -DAERONET_ENABLE_ZSTD=ON \
            -DAERONET_ENABLE_OPENTELEMETRY=OFF

      - name: Build
        run: |
          cmake --build build-pages --parallel

      - name: Run benchmarks
        working-directory: ${{github.workspace}}/build-pages/benchmarks/scripted-servers
        run: |
          # Decide duration and threads based on event type and inputs.
          # Defaults:
          #  - pull_request / non-main push => 5s, 1 thread (fast)
          #  - push to main => 30s, 2 threads
          #  - schedule or workflow_dispatch => use workflow input `bench_duration` (or default 90s), 2 threads

          EVENT_NAME=${GITHUB_EVENT_NAME:-}
          REF=${GITHUB_REF:-}
          WARMUP=5s

          if [ "$EVENT_NAME" = "push" ] && [ "$REF" = "refs/heads/main" ]; then
            DUR=30s
            THREADS=2
          elif [ "$EVENT_NAME" = "workflow_dispatch" ] || [ "$EVENT_NAME" = "schedule" ]; then
            if [ -n "${{ github.event.inputs.bench_duration }}" ]; then
              DUR="${{ github.event.inputs.bench_duration }}"
            else
              DUR=90s
            fi
            THREADS=2
          else
            # pull_request and non-main pushes
            DUR=5s
            WARMUP=2s
            THREADS=1
          fi

          echo "Event: $EVENT_NAME ref: $REF -> running for $DUR with $THREADS threads"
          ./run_benchmarks.py --duration "$DUR" --threads "$THREADS" --warmup "$WARMUP"

      - name: Render HTML for Pages
        run: |
          rm -fr /tmp/site/benchmarks
          mkdir -p /tmp/site/benchmarks
          benchmarks/scripted-servers/render_benchmarks_html.py \
            --input build-pages/benchmarks/scripted-servers/results/benchmark_latest.json \
            --output /tmp/site/benchmarks/index.html

          # Copy JSON so badge and raw data are available on Pages
          cp build-pages/benchmarks/scripted-servers/results/benchmark_latest.json /tmp/site/benchmarks/benchmark_latest.json
          if [[ -f build-pages/benchmarks/scripted-servers/results/benchmark_badge.json ]]; then
            cp build-pages/benchmarks/scripted-servers/results/benchmark_badge.json /tmp/site/benchmarks/benchmark_badge.json
          fi

      - name: Prepare repo URL
        if: ${{ github.event_name != 'pull_request' && startsWith(matrix.compiler, 'gcc') }}
        run: |
          echo "REPO=https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" >> $GITHUB_ENV

      - name: Publish site snapshot to gh-pages
        if: ${{ github.event_name != 'pull_request' && startsWith(matrix.compiler, 'gcc') }}
        run: |
          set -euo pipefail
          REPO="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"

          rm -rf /tmp/gh
          mkdir -p /tmp/gh

          # Populate the workspace with the snapshot from /tmp/site, then initialize git
          rsync -a --delete /tmp/site/ /tmp/gh/ || ( echo "rsync failed" && exit 1 )

          git -C /tmp/gh init
          git -C /tmp/gh checkout -b gh-pages || true
          git -C /tmp/gh add --all
          git -C /tmp/gh commit --allow-empty -m "Site snapshot from ${GITHUB_SHA}"
          # Ensure origin remote exists so lease can be compared correctly
          git -C /tmp/gh remote add origin "$REPO" || true
          # Try fetching remote gh-pages to populate refs for --force-with-lease; ignore failure if branch doesn't exist
          git -C /tmp/gh fetch --no-tags --depth=1 origin gh-pages || true
          # Push HEAD to gh-pages using --force-with-lease to avoid clobbering concurrent updates
          git -C /tmp/gh push --force-with-lease origin HEAD:gh-pages
